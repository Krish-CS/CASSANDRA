<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cassandra Login</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <!-- Google Fonts for the script text -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Poppins:wght@300;400;500&display=swap"
        rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <div class="background-container">
        <!-- Background image will be set in CSS or img tag -->
        <video autoplay muted loop playsinline class="bg-video"
            poster="{{ url_for('static', filename='img/pink_feather_background.png') }}">
            <source src="{{ url_for('static', filename='vid/cassandra_video.mp4') }}" type="video/mp4">
            <img src="{{ url_for('static', filename='img/pink_feather_background.png') }}" alt="Background"
                class="bg-img">
        </video>
    </div>

    <div class="login-container">
        <div class="glass-card">
            <h1 class="logo-text">Cassandra</h1>

            <form class="login-form">
                <div class="input-group">
                    <i class="fas fa-user input-icon"></i>
                    <input type="text" placeholder="Username or email" required>
                </div>

                <div class="input-group">
                    <i class="fas fa-lock input-icon"></i>
                    <input type="password" id="passwordInput" placeholder="Password" required>
                    <i class="fas fa-eye show-password-icon" onclick="togglePassword()"></i>
                </div>

                <div class="forgot-pass">
                    <a href="#">Forgot Password?</a>
                </div>

                <button type="submit" class="login-btn">
                    Login
                    <div class="btn-glow"></div>
                </button>

                <div class="divider">
                    <span>or</span>
                </div>

                <div class="india-login-section" style="text-align: center;">
                    <button type="button" onclick="checkIndiaLocation()" class="india-btn"
                        style="background: rgba(255, 255, 255, 0.25); border: 1px solid #ff9a9e; padding: 12px 20px; border-radius: 50px; color: #d66d75; font-weight: 600; cursor: pointer; width: 100%; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.5s ease; backdrop-filter: blur(5px); font-family: 'Poppins', sans-serif;">
                        <i class="fas fa-map-marker-alt" style="color: #d66d75;"></i> <span
                            style="color: #d66d75;">Login via India Location</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Username Modal -->
    <div id="usernameModal" class="modal-overlay"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 240, 245, 0.5); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(5px);">
        <div class="glass-card"
            style="width: 90%; max-width: 400px; padding: 40px; transform: scale(0.9); transition: transform 0.3s ease;">
            <h2 style="color: #d66d75; margin-bottom: 20px; font-family: 'Poppins', sans-serif;">One Last Step! âœ¨</h2>
            <p style="color: #d66d75; margin-bottom: 25px;">How should we call you?</p>

            <input type="text" id="newUsername" placeholder="Enter your name"
                style="width: 100%; padding: 12px 20px; border-radius: 50px; border: none; background: rgba(255,255,255,0.8); margin-bottom: 20px; color: #d66d75; outline: none; text-align: center;">

            <div style="display: flex; gap: 10px; justify-content: center;">
                <button onclick="skipName()"
                    style="padding: 10px 20px; border-radius: 50px; border: 1px solid #d66d75; background: transparent; color: #d66d75; cursor: pointer; transition: all 0.3s;">Skip</button>
                <button onclick="saveName()"
                    style="padding: 10px 20px; border-radius: 50px; border: none; background: linear-gradient(to right, #ff9a9e, #fad0c4); color: #fff; cursor: pointer; font-weight: bold; box-shadow: 0 4px 15px rgba(255, 154, 158, 0.4);">Set
                    Name</button>
            </div>
        </div>
    </div>

    <script>
        function togglePassword() {
            const passwordInput = document.getElementById('passwordInput');
            const icon = document.querySelector('.show-password-icon');
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        // Show Modal instead of redirect
        function showNameModal() {
            const modal = document.getElementById('usernameModal');
            modal.style.display = 'flex';
            setTimeout(() => {
                modal.querySelector('.glass-card').style.transform = 'scale(1)';
            }, 10);
        }

        function saveName() {
            const nameInput = document.getElementById('newUsername');
            const name = (nameInput.value.trim() || "CASSANDRIAN").toUpperCase();
            localStorage.setItem('cassandra_username', name);
            window.location.href = '/dashboard';
        }


        function skipName() {
            localStorage.setItem('cassandra_username', "CASSANDRIAN");
            window.location.href = '/dashboard';
        }

        // Form Submit Handler
        document.querySelector('.login-form').onsubmit = function (e) {
            e.preventDefault();
            // Here you would add real login validation
            showNameModal();
        };

        async function checkIndiaLocation() {
            const btn = document.querySelector('.india-btn');
            const icon = btn.querySelector('i');
            const textSpan = btn.querySelector('span');
            const originalContent = btn.innerHTML;

            // Set loading state and show "Verifying Location..."
            if (textSpan) textSpan.textContent = 'Verifying Location...';
            btn.disabled = true;

            // Immediately show Indian Flag colors (Orange, White, Green)
            btn.style.background = 'linear-gradient(90deg, #FF9933 0%, #FFFFFF 50%, #138808 100%)';
            btn.style.backgroundSize = '100% 100%';
            btn.style.backgroundRepeat = 'no-repeat';
            btn.style.border = 'none'; // Explicitly remove border to avoid color artifacts
            btn.style.boxShadow = '0 5px 15px rgba(0,0,0,0.1)';


            // Change text/icon colors for visibility on flag
            if (icon) icon.style.color = '#000080'; // Navy Blue (Ashok Chakra)
            if (textSpan) textSpan.style.color = '#000080';


            try {
                // Fetch location data
                const response = await fetch('https://ipapi.co/json/');

                if (!response.ok) {
                    throw new Error('Location check failed');
                }

                const data = await response.json();
                console.log("User Location:", data.country_name);

                if (data.country_name === 'India' || data.country_code === 'IN') {
                    // Success
                    if (textSpan) textSpan.textContent = 'Verified! Welcome ðŸ‡®ðŸ‡³';
                    if (icon) icon.className = 'fas fa-check-circle';

                    setTimeout(() => {
                        showNameModal();
                    }, 1000);
                } else {
                    // Failure
                    if (textSpan) textSpan.textContent = 'Access Restricted';
                    btn.style.background = '#ff6b6b'; // Error Red
                    if (textSpan) textSpan.style.color = '#fff';
                    if (icon) icon.style.color = '#fff';

                    setTimeout(() => {
                        // Reset
                        btn.style.background = 'rgba(255, 255, 255, 0.25)';
                        btn.style.border = '1px solid #ff9a9e';
                        btn.innerHTML = originalContent;
                        btn.disabled = false;
                    }, 2000);
                }
            } catch (error) {
                console.error(error);
                // Fallback / Error
                try {
                    const response2 = await fetch('http://ip-api.com/json/');
                    const data2 = await response2.json();
                    if (data2.country === 'India' || data2.countryCode === 'IN') {
                        if (textSpan) textSpan.textContent = 'Verified! Welcome ðŸ‡®ðŸ‡³';
                        setTimeout(() => { showNameModal(); }, 1000);
                        return;
                    }
                } catch (e) { }

                if (textSpan) textSpan.textContent = 'Verification Failed';
                btn.style.background = '#ff6b6b';
                if (textSpan) textSpan.style.color = '#fff';
                if (icon) icon.style.color = '#fff';

                setTimeout(() => {
                    btn.style.background = 'rgba(255, 255, 255, 0.25)';
                    btn.style.border = '1px solid #ff9a9e';
                    btn.innerHTML = originalContent;
                    btn.disabled = false;
                }, 2000);
            }
        }
    </script>

    <!-- Audio Player -->
    <audio id="bgAudio" loop>
        <source src="{{ url_for('static', filename='audio/cassandra_bg.mp3') }}" type="audio/mpeg">
    </audio>

    <div class="audio-control" id="audioControl" onclick="toggleAudio()">
        <i class="fas fa-volume-up"></i>
    </div>

    <style>
        .audio-control {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 9999;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            color: #d66d75;
        }

        .audio-control:hover {
            transform: scale(1.1);
            background: rgba(255, 255, 255, 0.4);
        }
    </style>

    <script>
        (function () {
            const audio = document.getElementById('bgAudio');
            const btn = document.getElementById('audioControl');
            const icon = btn.querySelector('i');

            // 1. Immediate State Restoration
            const isMuted = localStorage.getItem('cassandra_audio_muted') === 'true';
            const savedTime = parseFloat(localStorage.getItem('cassandra_audio_time')) || 0;

            if (savedTime) audio.currentTime = savedTime;
            audio.muted = isMuted;
            updateIcon(); // Initial icon state

            // 2. Play Function with Retry
            function attemptPlay() {
                const playPromise = audio.play();
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        console.warn("Autoplay / Resume blocked:", error);
                        // Unlock on ANY interaction
                        const unlock = () => {
                            audio.play();
                            document.removeEventListener('click', unlock);
                            document.removeEventListener('touchstart', unlock);
                            document.removeEventListener('keydown', unlock);
                        };
                        document.addEventListener('click', unlock, { once: true });
                        document.addEventListener('touchstart', unlock, { once: true });
                        document.addEventListener('keydown', unlock, { once: true });
                    });
                }
            }

            // Try to play immediately
            if (!audio.paused) return; // Already playing
            attemptPlay();

            // 3. Persistence
            window.addEventListener('beforeunload', () => {
                localStorage.setItem('cassandra_audio_time', audio.currentTime);
            });

            // Save frequently in case of crash/unexpected close
            setInterval(() => {
                if (!audio.paused) {
                    localStorage.setItem('cassandra_audio_time', audio.currentTime);
                }
            }, 1000);

            // 4. Bfcache / Back Button Support
            window.addEventListener('pageshow', (event) => {
                if (event.persisted) {
                    // Page restored from cache
                    const reTime = parseFloat(localStorage.getItem('cassandra_audio_time')) || 0;
                    if (reTime) audio.currentTime = reTime;
                    attemptPlay();
                }
            });

            // 5. Controls
            window.toggleAudio = function () {
                audio.muted = !audio.muted;
                localStorage.setItem('cassandra_audio_muted', audio.muted);
                updateIcon();
            }

            function updateIcon() {
                if (audio.muted) {
                    icon.className = 'fas fa-volume-mute';
                    btn.style.background = 'rgba(255, 255, 255, 0.1)';
                } else {
                    icon.className = 'fas fa-volume-up';
                    btn.style.background = 'rgba(255, 255, 255, 0.25)';
                }
            }
        })();
    </script>
</body>

</html>